name: Minikube deployment 

run-name: "[Image-tag- ${{ inputs.Tag }}] [event- ${{ github.event_name }}]"
on:
  workflow_dispatch:
    inputs:
      Tag:
        description: 'Tag of the image to test'
        required: true
        default: 'rel.25.12.11'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      RELEASE_NAME: kannan-aks
      NAMESPACE: default
      IMAGE_REPOSITORY: kannan1809/docker-aishu
      IMAGE_TAG: ${{ inputs.Tag }}
      HELM_CHART_SUBPATH: kannan-aks-image

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Checkout helm chart repo
        uses: actions/checkout@v4
        with:
          repository: Aika1804/helm-platform
          path: helm-platform

      - name: Refresh PATH and verify prerequisites
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          kubectl version --client
          minikube status
          helm version
          kubectl config current-context

      - name: Ensure Minikube context
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          kubectl config use-context minikube
          kubectl get nodes

      - name: Deploy with Helm
        shell: powershell
        working-directory: helm-platform
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          $CHART_PATH = "${env:HELM_CHART_SUBPATH}"
          helm upgrade --install "${env:RELEASE_NAME}" $CHART_PATH `
            --namespace "${env:NAMESPACE}" `
            --create-namespace `
            --set image.repository="${env:IMAGE_REPOSITORY}" `
            --set image.tag="${env:IMAGE_TAG}"
          Write-Output "✅ Helm deployment completed!"

      - name: Wait for pods to be ready
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          Write-Output "Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance="${env:RELEASE_NAME}" -n "${env:NAMESPACE}" --timeout=300s

      - name: Verify deployment
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          
          Write-Output "=== Pods ==="
          kubectl get pods -n "${env:NAMESPACE}" -l app.kubernetes.io/instance="${env:RELEASE_NAME}" --show-labels
          
          Write-Output "=== All Pods ==="
          kubectl get pods -n "${env:NAMESPACE}" -o wide
          
          Write-Output "=== Services ==="
          kubectl get svc -n "${env:NAMESPACE}"
          
          Write-Output "=== All Resources ==="
          kubectl get all -n "${env:NAMESPACE}"
          
          Write-Output "✅ Deployment verified successfully!"
