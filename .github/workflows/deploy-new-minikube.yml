name: Deploy to Minikube with Helm

run-name: "[Image-tag- ${{ inputs.Tag }}] [event- ${{ github.event_name }}]"
on:
  workflow_dispatch:
    inputs:
      Tag:
        description: 'Tag of the image to test'
        required: true
        default: 'rel.25.12.11'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      RELEASE_NAME: kannan-aks
      NAMESPACE: default
      IMAGE_REPOSITORY: kannan1809/docker-aishu
      IMAGE_TAG: ${{ inputs.Tag }}
      HELM_CHART_SUBPATH: kannan-aks-image

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Checkout helm chart repo
        uses: actions/checkout@v4
        with:
          repository: Aika1804/helm-platform
          path: helm-platform

      - name: Verify prerequisites
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          kubectl version --client
          minikube status
          helm version
          kubectl config current-context

      - name: Clean previous deployment
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          helm uninstall "${env:RELEASE_NAME}" -n "${env:NAMESPACE}" || Write-Output "No previous release"
          kubectl delete all -l app.kubernetes.io/instance="${env:RELEASE_NAME}" -n "${env:NAMESPACE}" --ignore-not-found=true || Write-Output "No resources found"

      - name: Deploy with Helm (Probes Disabled)
        shell: cmd
        working-directory: helm-platform
        run: |
          set PATH=%PATH%;C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube
          helm upgrade --install %RELEASE_NAME% %HELM_CHART_SUBPATH% ^
            --namespace %NAMESPACE% ^
            --create-namespace ^
            --set image.repository=%IMAGE_REPOSITORY% ^
            --set image.tag=%IMAGE_TAG% ^
            --set livenessProbe.enabled=false ^
            --set readinessProbe.enabled=false
          echo ✅ Deployment completed!

      - name: Verify deployment
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User") + ";C:\Program Files\Kubernetes\Bin;C:\Program Files\Minikube"
          
          Write-Output "=== Pods ==="
          kubectl get pods -n "${env:NAMESPACE}" -l app.kubernetes.io/instance="${env:RELEASE_NAME}"
          
          Write-Output "=== All Resources ==="
          kubectl get all -n "${env:NAMESPACE}"
          
          Write-Output "✅ SUCCESS - Pods should be Running!"
